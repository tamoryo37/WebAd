# 広告運用管理システム - 要件定義書

## 1. プロジェクト概要

### 1.1 システム名
広告運用管理システム（Ad Operations Management System）

### 1.2 目的
パチンコ店舗の広告運用業務を効率化し、キャンペーン管理、予算追跡、進捗管理、外部ユーザーとの協業を一元管理するWebアプリケーション

### 1.3 対象ユーザー
- 内部スタッフ（管理者・一般スタッフ）：広告運用チーム
- 外部ユーザー（閲覧者）：クライアント企業の担当者

### 1.4 ビジネスモデル
**マルチテナント型BPOサービス**
- 複数クライアント企業が同一システムを利用
- クライアントごとにデータを完全分離
- テナント単位での権限管理・課金管理

---

## 2. 機能要件

### 2.1 認証・権限管理機能
**優先度：高**

#### 機能詳細
- メール/パスワード認証（Supabase Auth）
- ユーザーロール管理
  - **システム管理者（system_admin）**：全テナント管理可能
  - **管理者（admin）**：自テナント内の全機能アクセス可
  - **担当者（staff）**：自身が作成したデータ + 担当メディアのみアクセス可
  - **外部ユーザー（external）**：割り当てられたキャンペーンのみ閲覧可
- **マルチテナント対応**
  - テナント（クライアント企業）単位でのデータ分離
  - テナント横断アクセス不可（RLSで厳格に制御）
- **メディア別アクセス制御**
  - 担当者は自身が担当するメディア（Meta、Google、LINE等）のみアクセス可
- **データ所有者制御**
  - 担当者は自身が作成したキャンペーン・店舗データのみ編集可
  - 閲覧は担当メディアの範囲で可能
- セッション管理
- パスワード変更機能

#### データモデル
- `tenants` テーブル（新規）
  - id (uuid)
  - name (text) - クライアント企業名
  - subdomain (text) - サブドメイン識別子
  - is_active (boolean)
  - subscription_plan (text) - 契約プラン
  - created_at/updated_at (timestamp)

- `users` テーブル（更新）
  - id (uuid)
  - tenant_id (uuid) **[追加]** - 所属テナント
  - email (text)
  - username (text)
  - full_name (text)
  - role (enum: system_admin/admin/staff/external) **[変更]**
  - assigned_media (text[]) **[追加]** - 担当メディア配列 ['meta', 'google', 'line', 'yahoo']
  - is_active (boolean)
  - created_at/updated_at (timestamp)

- `campaigns` テーブル（更新）
  - tenant_id (uuid) **[追加]** - 所属テナント
  - created_by (uuid) **[追加]** - 作成者ユーザーID
  - media_type (text) **[追加]** - メディア種別（meta/google/line/yahoo）
  - （既存フィールド省略）

- 全主要テーブルに `tenant_id` と `created_by` を追加

---

### 2.2 ダッシュボード機能
**優先度：高**

#### 機能詳細
- KPI サマリー表示
  - 総キャンペーン数
  - アクティブキャンペーン数
  - 今月の予算使用率
  - アラート件数
- ガントチャート表示
  - キャンペーンスケジュール可視化
  - 期間フィルタリング（今週・今月・全期間）
- 月次ダッシュボード
  - 月別売上・予算データ
  - CSVエクスポート機能

#### データモデル
- `campaigns` テーブル（32件のデータ）
- `budget_tracking` テーブル
- `campaign_progress` テーブル
- `monthly_dashboard` テーブル

---

### 2.3 店舗管理機能
**優先度：中**

#### 機能詳細
- 店舗一覧表示
- 店舗情報CRUD操作
  - 店舗名、住所、電話番号、営業時間
- 店舗画像管理
  - 画像アップロード（外観・内観・機種写真等）
  - 画像削除・差し替え
- 月次資料管理
  - 月別PDF・Excel資料のアップロード
  - 資料ダウンロード機能

#### データモデル
- `stores` テーブル
- `store_images` テーブル
- `store_monthly_documents` テーブル

---

### 2.4 入稿管理機能（キャンペーン管理）
**優先度：最高**

#### 機能詳細
- キャンペーン一覧表示
  - タブ切り替え（全て・進行中・完了・未納品・要確認）
  - 検索・フィルタリング機能
    - 店舗名、キャンペーン名、媒体、ステータス
- キャンペーン詳細管理
  - 基本情報（キャンペーン名、アカウント名、期間）
  - 広告媒体情報（Meta、Google、LINE、Yahoo等）
  - 予算・実績トラッキング
  - クリエイティブ情報
    - テキスト、画像URL、動画URL
  - ステータス管理（企画中・制作中・レビュー中・配信中・完了）
  - 担当者アサイン
- CSVインポート/エクスポート機能
- ViewTabs切り替え
  - リスト表示
  - カレンダー表示
  - タイムライン表示

#### データモデル
- `campaigns` テーブル（32件）
  - 媒体別フィールド（meta_*, google_*, line_*, yahoo_*）
  - creative_text, creative_image_url, creative_video_url
  - status, person_in_charge
  - budget_amount, actual_spend

---

### 2.5 未消化管理機能
**優先度：高**

#### 機能詳細
- 未消化キャンペーン一覧表示
  - 予算に対する実績が未達成のキャンペーン
  - 未消化額・未消化率の表示
- アラート表示
  - 未消化率が閾値を超えたキャンペーン
  - 配信終了間近のキャンペーン
- キャンペーン詳細へのジャンプ機能

#### データモデル
- `budget_tracking` テーブル
- `campaign_alerts` テーブル

---

### 2.6 広告運用管理機能
**優先度：高**

#### 機能詳細
- 運用中キャンペーンの一覧表示
- リアルタイム進捗トラッキング
- パフォーマンス指標表示
  - インプレッション数
  - クリック数
  - CVR（コンバージョン率）
  - CPA（獲得単価）
- グラフ・チャートによる可視化

#### データモデル
- `campaigns` テーブル
- `campaign_progress` テーブル

---

### 2.7 外部ユーザー向け閲覧機能
**優先度：高**

#### 機能詳細
- 割り当てられたキャンペーンのみ表示
- 読み取り専用ビュー
- ダウンロード機能（クリエイティブ、レポート）

#### データモデル
- `user_campaign_assignments` テーブル
  - 階層型アサイン（キャンペーン→店舗→全体）

---

### 2.8 ユーザー管理機能
**優先度：中**

#### 機能詳細
- ユーザー一覧表示
- ユーザーCRUD操作
- ロール変更
- アクティブ/非アクティブ切り替え
- **権限設定機能**
  - **表示範囲設定**
    - 全てのデータ（管理者・マネージャー向け）
    - 自分が担当のデータのみ（営業担当者向け）
    - 個別指定したキャンペーンのみ（外部ユーザー向け）
  - **キャンペーン選択機能**（個別指定時）
    - 検索フィールド：キャンペーン名・アカウント名で検索
    - 担当者フィルター：ドロップダウンで担当者を選択
    - メディアフィルター：ドロップダウンでメディアを選択
  - **機能別権限（CRUD）設定**
    - ダッシュボード
    - 店舗管理
    - 入稿管理
    - キャンペーン管理
    - 未消化管理
    - 広告運用管理
    - バックアップ
    - 操作履歴
    - ユーザー管理

#### データモデル
- `users` テーブル
- `user_permissions` テーブル
- `user_campaign_access` テーブル

---

### 2.9 設定機能
**優先度：中**

#### 機能詳細
- データバックアップ設定
  - 自動バックアップ頻度設定
  - 手動バックアップ実行
  - バックアップ履歴表示
- ChatWork通知設定
  - Webhook URL設定
  - 通知イベント選択
- 操作履歴
  - 全操作のログ記録
  - ユーザー別フィルタリング

#### データモデル
- `backup_settings` テーブル
- `data_backups` テーブル
- `chatwork_notification_settings` テーブル
- `operation_history` テーブル

---

## 3. 非機能要件

### 3.1 パフォーマンス
- ページロード時間：2秒以内
- データ取得：1秒以内
- 同時接続ユーザー数：50人（テナントあたり）
- 全体同時接続：500人（10テナント想定）

### 3.2 セキュリティ（マルチテナント対応）
**3層セキュリティモデル**

#### レイヤー1：テナント分離
- 全テーブルに `tenant_id` カラムを必須化
- RLSで他テナントのデータへのアクセスを完全遮断
- ユーザーは自身の所属テナントのデータのみアクセス可能

#### レイヤー2：所有者制御（担当者用）
- 担当者（staff）は自身が作成したデータ（`created_by = auth.uid()`）のみ編集可能
- 閲覧は担当メディアの範囲で可能

#### レイヤー3：メディア別アクセス制御
- 担当者は自身の `assigned_media` 配列に含まれるメディアのキャンペーンのみアクセス可能
- 例：Meta担当者はGoogle広告のキャンペーンにアクセス不可

#### 共通セキュリティ対策
- Supabase Row Level Security（RLS）による行レベルアクセス制御
- HTTPS通信
- パスワードハッシュ化
- SQLインジェクション対策
- XSS対策
- CSRF対策
- 操作ログ記録（監査証跡）

### 3.3 可用性
- 稼働率：99%以上
- データバックアップ：日次

### 3.4 スケーラビリティ（マルチテナント対応）
- **テナント数**: 10〜50社まで対応
- **テナントあたりのデータ量**:
  - キャンペーン：1,000件/テナント
  - 店舗：500店舗/テナント
  - ユーザー：50人/テナント
- **全体データ量**: 50,000キャンペーン程度まで
- **全体ユーザー数**: 500ユーザー程度まで

### 3.5 ブラウザ対応
- Chrome（最新版）
- Safari（最新版）
- Edge（最新版）
- Firefox（最新版）

### 3.6 レスポンシブ対応
**完全レスポンシブWebアプリケーション**

システムは全デバイスで最適な表示・操作性を提供します。ネイティブアプリは開発せず、レスポンシブWebデザインでモバイル対応を実現します。

#### デスクトップ（1920x1080以上推奨）
- フル機能のダッシュボード
- マルチカラムレイアウト
- 詳細なデータテーブル表示
- サイドバーナビゲーション常時表示

#### タブレット（768px〜1024px）
- 2カラムレイアウト
- タッチ操作最適化
- サイドバーは折りたたみ可能
- テーブルのスクロール対応

#### モバイル（375px〜767px）
- 1カラムレイアウト
- ハンバーガーメニュー
- タッチターゲットサイズ最適化（最低44x44px）
- カード型UI
- 簡略化されたフォーム入力
- スワイプジェスチャー対応
- フローティングアクションボタン（FAB）

#### PWA対応（オプション）
- ホーム画面追加機能
- オフライン対応（限定的）
- プッシュ通知（将来拡張）

---

## 4. 技術スタック

### 4.1 フロントエンド
- **フレームワーク**: React 18.3.1 + TypeScript
- **ビルドツール**: Vite 5.4.2
- **スタイリング**: Tailwind CSS 3.4.1（レスポンシブデザイン対応）
- **アイコン**: Lucide React 0.344.0
- **CSV処理**: PapaParse 5.5.3

### 4.2 バックエンド
- **BaaS**: Supabase
  - PostgreSQL データベース
  - Authentication（メール/パスワード）
  - Storage（画像・ファイル保存）
  - Row Level Security（RLS）

### 4.3 インフラ
- **ホスティング**: Vercel / Netlify 想定
- **データベース**: Supabase（クラウド）

---

## 5. データベース設計

### 5.1 テーブル一覧（17テーブル）

| テーブル名 | 説明 | レコード数 | tenant_id | created_by |
|-----------|------|-----------|-----------|------------|
| **tenants** | **テナント（クライアント企業）情報** | **-** | **-** | **-** |
| users | ユーザー情報 | - | ✓ | - |
| stores | 店舗情報 | - | ✓ | ✓ |
| campaigns | キャンペーン情報 | 32 | ✓ | ✓ |
| budget_tracking | 予算トラッキング | - | ✓ | ✓ |
| campaign_progress | キャンペーン進捗 | - | ✓ | ✓ |
| campaign_alerts | アラート情報 | - | ✓ | - |
| store_images | 店舗画像 | - | ✓ | ✓ |
| store_monthly_documents | 月次資料 | - | ✓ | ✓ |
| user_campaign_access | ユーザー-キャンペーンアクセス | - | ✓ | - |
| user_permissions | ユーザー権限（CRUD） | - | ✓ | - |
| backup_settings | バックアップ設定 | - | ✓ | - |
| data_backups | バックアップ履歴 | - | ✓ | - |
| chatwork_notification_settings | ChatWork通知設定 | - | ✓ | - |
| operation_history | 操作履歴 | - | ✓ | - |
| monthly_dashboard | 月次ダッシュボード | - | ✓ | - |
| dummy_data_sets | ダミーデータ | - | ✓ | - |

### 5.2 主要リレーション（マルチテナント対応）
```
tenants (1) ─── (N) users
tenants (1) ─── (N) campaigns
tenants (1) ─── (N) stores
tenants (1) ─── (N) 全テーブル

users (1) ─── (N) campaigns (person_in_charge)
users (1) ─── (N) campaigns (created_by)
users (1) ─── (N) stores (created_by)
users (1) ─── (N) user_campaign_access
campaigns (1) ─── (N) user_campaign_access
stores (1) ─── (N) campaigns
stores (1) ─── (N) store_images
stores (1) ─── (N) store_monthly_documents
campaigns (1) ─── (N) budget_tracking
campaigns (1) ─── (N) campaign_progress
campaigns (1) ─── (N) campaign_alerts
```

### 5.3 RLSポリシー例（3層セキュリティ）

#### campaigns テーブル

**SELECT ポリシー（閲覧）:**
```sql
-- 管理者：自テナントの全データ
(SELECT role FROM users WHERE id = auth.uid()) = 'admin'
AND tenant_id = (SELECT tenant_id FROM users WHERE id = auth.uid())

-- 担当者：自テナント内で、自身の担当メディアのキャンペーンのみ
(SELECT role FROM users WHERE id = auth.uid()) = 'staff'
AND tenant_id = (SELECT tenant_id FROM users WHERE id = auth.uid())
AND media_type = ANY((SELECT assigned_media FROM users WHERE id = auth.uid()))

-- 外部ユーザー：割り当てられたキャンペーンのみ
(SELECT role FROM users WHERE id = auth.uid()) = 'external'
AND id IN (SELECT campaign_id FROM user_campaign_access WHERE user_id = auth.uid())
```

**UPDATE ポリシー（編集）:**
```sql
-- 管理者：自テナントの全データ
(SELECT role FROM users WHERE id = auth.uid()) = 'admin'
AND tenant_id = (SELECT tenant_id FROM users WHERE id = auth.uid())

-- 担当者：自身が作成したデータのみ
(SELECT role FROM users WHERE id = auth.uid()) = 'staff'
AND created_by = auth.uid()
AND tenant_id = (SELECT tenant_id FROM users WHERE id = auth.uid())
```

---

## 6. リスク管理

### 6.1 技術リスク
| リスク | 影響度 | 対策 |
|--------|--------|------|
| **Supabase RLS 複雑化によるパフォーマンス低下** | **高** | マルチテナント + 所有者制御 + メディア制御の3重チェックが必要。インデックス最適化、クエリプラン検証、負荷テストを徹底実施 |
| **テナント間データ漏洩** | **最高** | RLSポリシーの徹底テスト、ペネトレーションテスト実施 |
| CSV インポート時の大量データ処理 | 中 | バッチ処理・チャンク分割実装 |
| 外部API（ChatWork）の障害 | 低 | リトライ機構・エラーハンドリング実装 |
| **モバイルデバイスでのパフォーマンス** | 中 | 画像最適化、遅延ローディング、軽量コンポーネント設計 |

### 6.2 スケジュールリスク
| リスク | 影響度 | 対策 |
|--------|--------|------|
| 要件変更による遅延 | 高 | アジャイル開発・週次レビュー実施 |
| キーマンの離脱 | 高 | ドキュメント整備・ペアプログラミング |

### 6.3 運用リスク
| リスク | 影響度 | 対策 |
|--------|--------|------|
| データ損失 | 高 | 日次自動バックアップ・手動バックアップ機能 |
| 不正アクセス | 中 | RLS厳格化・操作ログ記録 |
| **テナント間データ混在** | **最高** | テナントID必須チェック、全クエリにtenant_idフィルタ強制 |

---

## 7. 今後の拡張案

### 7.1 Phase 2（追加開発候補）
- **レポート自動生成機能**
  - PDF/Excel 形式での月次レポート出力
- **ダッシュボードカスタマイズ機能**
  - ユーザーごとのウィジェット配置
- **PWA化**
  - ホーム画面追加
  - オフライン対応（限定的）
  - プッシュ通知

### 7.2 Phase 3（長期展望）
- **AI による予算最適化提案**
  - 過去データからの予算配分推奨
- **リアルタイムコラボレーション**
  - 複数ユーザー同時編集
- **API 連携強化**
  - Meta Ads API
  - Google Ads API
  - LINE Ads API

---

## 8. まとめ

本システムは、広告運用業務の効率化を目的とした包括的な管理ツールです。

### 主要メリット
1. **業務効率化**: キャンペーン管理を一元化し、作業時間を50%削減
2. **可視化**: ダッシュボードで進捗・予算をリアルタイム把握
3. **コラボレーション**: 外部ユーザーとのスムーズな情報共有
4. **マルチテナント対応**: 複数クライアント企業を安全に管理、BPO事業に最適
5. **厳格な権限制御**: テナント分離 + 所有者制御 + メディア別アクセス制御の3層セキュリティ
6. **セキュリティ**: Supabase RLS による厳格なアクセス制御とデータ漏洩防止
7. **拡張性**: モジュール設計により将来の機能追加が容易
8. **マルチデバイス対応**: レスポンシブWebデザインでデスクトップからモバイルまで最適な体験を提供

### 成功の鍵
- **段階的リリース**: MVP（最小限の機能）から始め、ユーザーフィードバックを反映
- **継続的改善**: 週次スプリントでアジャイル開発
- **ユーザー巻き込み**: 開発初期からエンドユーザーの意見を収集

---

**作成日**: 2025年10月7日
**最終更新日**: 2025年10月7日
**バージョン**: 2.1
**作成者**: 開発チーム

---

## 9. 変更履歴

### バージョン 2.1（2025年10月7日）
- **ユーザー割当管理機能を削除**：独立した「ユーザー割り当て」メニューを廃止し、権限設定に統合
- **メディア権限タブを削除**：user_media_accessテーブルの利用を終了し、キャンペーン選択でメディアフィルターを使用する方式に変更
- **キャンペーン選択機能を改善**：個別指定時に検索、担当者フィルター、メディアフィルターの3つの絞り込み機能を追加
- **機能別権限にダッシュボードを追加**：ダッシュボードのアクセス権限をCRUD設定で管理可能に
- **テーブル数を更新**：18テーブル→17テーブル（user_media_access削除、user_campaign_assignmentsをuser_campaign_accessに統一）
